# FFAB 文件格式

FFA Bundle (.ffab) 是一种二进制文件格式，用于存储序列帧图片资源。该格式设计简洁高效，支持快速随机访问任意帧，特别适合动画播放场景。

## 版本历史

| 版本号 | 发布日期 | 主要变化 |
|--------|----------|----------|
| 0x01   | TBD      | 初始版本，定义基本文件结构、Meta信息区、索引表和图片数据区 |

## 概述

FFAB 格式专为高性能帧动画设计，具有以下特点：

- 简洁的二进制结构，解析速度快
- 支持快速随机访问任意帧
- 紧凑的索引表
- 支持多种图片压缩格式

## 文件结构

FFAB 文件由四部分组成：

1. **文件头 (Header)**：包含文件标识和版本信息
2. **Meta 信息区 (Meta)**：包含图片数量、尺寸等元数据
3. **索引表 (Index Table)**：每张图片的位置和长度信息
4. **图片数据区 (Data)**：存储所有压缩后的图片数据

```
+-------------------+
|   文件头 (3字节)    |
+-------------------+
|   Meta 信息区 (7字节)|
+-------------------+
|   索引表           |
|   (Count * 12字节) |
+-------------------+
|   图片数据区        |
|   (可变长度)        |
+-------------------+
```

## 文件头格式

文件头固定为 3 字节，包含以下字段：

```
偏移量  长度    类型         描述
0      2      uint16       魔数 (0xFFAB)
2      1      uint8        版本号 (最大 0xFF)
```

### 魔数

FFAB 文件的魔数为 `0xFFAB`，用于快速识别文件格式。

### 版本号

当前版本号为 `0x01`，用于未来格式升级。

### 版本兼容性处理

FFAB 格式设计遵循以下版本兼容性原则：

1. **文件头固定不变**：所有版本共享相同的文件头结构（3字节）
2. **版本特定处理**：读取文件时，根据版本号选择对应的解析方式
3. **向前兼容**：新版本应能读取旧版本文件，旧版本可能无法读取新版本文件

### 版本1 (0x01) 定义

版本1定义了以下固定结构：
- Meta 信息区：固定7字节
- 索引表：每项固定12字节
- 图片数据区：顺序存储压缩图片数据

### 未来版本扩展指南

未来版本升级时，可以考虑以下扩展方式：
- 扩展Meta信息区结构（增加新字段）
- 修改索引表结构（增加更多元数据）
- 添加新的图片压缩格式支持
- 引入数据压缩或加密机制

版本升级时，应确保版本号字段正确标识文件格式版本，以便解析器选择正确的处理方式。

## Meta 信息区格式

Meta 信息区固定为 7 字节，包含以下字段：

```
偏移量  长度    类型         描述
0      2      uint16       图片总数 (最大 0xFFFF)
2      2      uint16       图片宽度 (最大 0xFFFF)
4      2      uint16       图片高度 (最大 0xFFFF)
6      1      uint8        图片压缩格式 (最大 0xFF)
```

### 图片总数

Meta 信息区中包含的图片总数，最大支持 65535 张 (0xFFFF)。

### 图片宽度和高度

所有图片的统一尺寸，宽度和高度最大支持 65535 像素 (0xFFFF)。

### 图片压缩格式

指定图片数据的压缩格式：

| 值 | 格式 | 描述 |
|----|------|------|
| 0x01 | ASTC LDR 4x4 | ASTC LDR 4x4 压缩 |
| 0x02 | ASTC LDR 6x6 | ASTC LDR 6x6 压缩 |
| 0x03 | ASTC LDR 8x8 | ASTC LDR 8x8 压缩 |

## 索引表格式

索引表是一个结构体数组，每个元素对应一张图片，包含该图片在文件中的位置和长度信息。

### 索引项结构

每个索引项固定为 12 字节：

```
偏移量  长度     类型         描述
0       8      uint64       图片数据偏移量 (相对于文件开始)
8       4      uint32       图片数据长度 (字节) 
```

### 索引表总长度

索引表总长度 = 图片总数 × 12 字节

## 图片数据区

图片数据区按顺序存储所有压缩后的图片数据。每张图片的数据可以独立解压，不影响其他图片。

### 数据布局

```
+------------------+
|   图片1数据       |
+------------------+
|   图片2数据       |
+------------------+
|   ...             |
+------------------+
|   图片N数据       |
+------------------+
```

## 文件扩展名

FFAB 文件使用 `.ffab` 作为扩展名。

MIME 类型为 `application/x-ffa-bundle`。

## 兼容性

FFAB 格式设计考虑了向前兼容性：

- **文件头固定不变**：所有版本共享相同的文件头结构（3字节），其中版本号用于标识格式版本
- **版本特定处理**：解析器必须根据版本号选择正确的解析方式处理Meta信息区、索引表和图片数据区
- **向前兼容**：新版本应能读取旧版本文件，旧版本可能无法读取新版本文件

### 版本处理流程

解析器处理FFAB文件时应遵循以下流程：

1. 读取文件头（3字节），验证魔数并获取版本号
2. 根据版本号选择对应的解析方式：
   - 版本1：按照当前文档定义的结构解析
   - 其他版本：按照该版本特定的规范解析
3. 如果遇到不支持的版本号，解析器应提供明确的错误信息

### 版本升级注意事项

- 版本升级不得改变文件头结构
- 新版本应保持对旧版本文件的读取能力
- 重大变更应考虑使用主版本号升级方式

## 工具支持

FFAB 格式提供以下工具支持：

1. **打包工具**：将图片序列打包为 FFAB 文件
2. **解包工具**：将 FFAB 文件解包为图片序列
3. **分析工具**：分析 FFAB 文件结构和内容

## 压缩格式对比

| 格式 | 压缩方式 | 透明支持 | 典型压缩率 | GPU直接支持 | 适用场景 |
|------|----------|----------|------------|------------|----------|
| PNG | 无损压缩 | 支持 | 2:1 - 5:1 | 否 | 需要精确保留原始内容的图像 |
| JPEG | 有损压缩 | 不支持 | 10:1 - 20:1 | 否 | 照片等连续色调图像 |
| ASTC 4×4 | 有损压缩 | 支持 | 3:1 | 是 | 高质量要求的动画帧 |
| ASTC 6×6 | 有损压缩 | 支持 | 6.7:1 | 是 | 大多数动画场景（推荐） |
| ASTC 8×8 | 有损压缩 | 支持 | 12:1 | 是 | 背景等对细节要求不高的内容 |
